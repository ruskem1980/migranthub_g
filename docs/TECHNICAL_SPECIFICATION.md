# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: MigrantHub

**–í–µ—Ä—Å–∏—è:** 1.0
**–î–∞—Ç–∞:** 2025-01-25
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

## 1. –û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è

### 1.1 –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
**MigrantHub** ‚Äî –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ç—Ä—É–¥–æ–≤—ã—Ö –º–∏–≥—Ä–∞–Ω—Ç–æ–≤ –≤ –†–æ—Å—Å–∏–∏

### 1.2 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–º–æ—â—å —Ç—Ä—É–¥–æ–≤—ã–º –º–∏–≥—Ä–∞–Ω—Ç–∞–º –≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–∏ —Å—Ä–æ–∫–æ–≤, –ø–æ–ª—É—á–µ–Ω–∏–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –æ—Ä–≥–∞–Ω–∞–º–∏.

### 1.3 –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è
- –¢—Ä—É–¥–æ–≤—ã–µ –º–∏–≥—Ä–∞–Ω—Ç—ã –∏–∑ —Å—Ç—Ä–∞–Ω –°–ù–ì (–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω, –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω, –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω)
- –í–æ–∑—Ä–∞—Å—Ç: 18-55 –ª–µ—Ç
- –£—Ä–æ–≤–µ–Ω—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏: –±–∞–∑–æ–≤—ã–π
- –Ø–∑—ã–∫–∏: —Ä—É—Å—Å–∫–∏–π, —É–∑–±–µ–∫—Å–∫–∏–π, —Ç–∞–¥–∂–∏–∫—Å–∫–∏–π, –∫—ã—Ä–≥—ã–∑—Å–∫–∏–π

### 1.4 –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

| –ü—Ä–∏–Ω—Ü–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| **Local-First** | –í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| **–ù–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –ü–î–Ω** | –°–µ—Ä–≤–µ—Ä –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Üí –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –†–æ—Å–∫–æ–º–Ω–∞–¥–∑–æ—Ä–µ |
| **E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** | –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ, —Å–µ—Ä–≤–µ—Ä –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ blob |
| **Offline-capable** | –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ |

---

## 2. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

### 2.1 –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ (70-80%)

#### Frontend (apps/frontend)
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| Next.js 14 + Capacitor | ‚úÖ | –û—Å–Ω–æ–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è UI | ‚úÖ | Phone + OTP flow |
| –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è | ‚úÖ | 5 —è–∑—ã–∫–æ–≤ (RU, UZ, TJ, KY, EN) |
| Bottom Navigation | ‚úÖ | 5 –≤–∫–ª–∞–¥–æ–∫ |
| Zustand + React Query | ‚úÖ | State management |
| PWA + Service Worker | ‚úÖ | Offline support |
| IndexedDB (Dexie) | ‚úÖ | –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ |
| Document Wizard | ‚úÖ | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
| Passport Scanner UI | ‚úÖ | OCR-ready –∫–æ–º–ø–æ–Ω–µ–Ω—Ç |

#### Backend (apps/legal-core)
| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| NestJS –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å | ‚úÖ | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Web Scraping | ‚úÖ | pravo.gov.ru, garant.ru |
| Diff Engine | ‚úÖ | SHA-256 —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ |
| RabbitMQ | ‚úÖ | Event publishing |
| REST API | ‚úÖ | CRUD –∑–∞–∫–æ–Ω–æ–≤ |

### 2.2 –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

| –ú–æ–¥—É–ª—å | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|-----------|----------|
| Backend Core API | P0 | –û—Å–Ω–æ–≤–Ω–æ–π API —Å–µ—Ä–≤–µ—Ä |
| Identity Service | P0 | –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, —Å–µ—Å—Å–∏–∏ |
| Document Processing | P0 | OCR, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
| AI Assistant | P1 | –ß–∞—Ç —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º AI |
| Payments | P1 | –°–ë–ü, –ÆKassa |
| Notifications | P1 | Push, Telegram |
| SOS Service | P2 | –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å |
| Admin Dashboard | P2 | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π |

---

## 3. –ú–æ–¥—É–ª—å 1: Backend Core API

### 3.1 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–û—Å–Ω–æ–≤–Ω–æ–π API —Å–µ—Ä–≤–µ—Ä –Ω–∞ NestJS, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### 3.2 –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
```
Runtime:     Node.js 20 LTS
Framework:   NestJS 10
Database:    PostgreSQL 16
Cache:       Redis 7
Queue:       RabbitMQ 3 / BullMQ
ORM:         TypeORM / Prisma
Validation:  class-validator + class-transformer
Docs:        Swagger/OpenAPI
```

### 3.3 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
```
apps/api-core/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/           # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users/          # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∞–Ω–æ–Ω–∏–º–Ω—ã–µ)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backup/         # Cloud Safe (E2E backup)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ billing/        # –ü–æ–¥–ø–∏—Å–∫–∏, –ø–ª–∞—Ç–µ–∂–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notifications/  # Push, email, telegram
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health/         # Health checks
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/         # Auth guards
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ interceptors/   # Logging, transform
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ filters/        # Exception handling
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ decorators/     # Custom decorators
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.ts
‚îÇ   ‚îî‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ test/
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ package.json
```

### 3.4 –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ API

#### 3.4.1 –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
```typescript
// POST /api/v1/auth/device
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
interface DeviceAuthRequest {
  deviceId: string;        // UUID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  platform: 'ios' | 'android' | 'web';
  appVersion: string;
  locale: string;
}

interface DeviceAuthResponse {
  accessToken: string;     // JWT, TTL 24h
  refreshToken: string;    // TTL 30 days
  userId: string;          // –ê–Ω–æ–Ω–∏–º–Ω—ã–π UUID
}

// POST /api/v1/auth/social
// –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ü. —Å–µ—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
interface SocialAuthRequest {
  provider: 'telegram' | 'vk';
  token: string;
}

// POST /api/v1/auth/refresh
interface RefreshRequest {
  refreshToken: string;
}
```

#### 3.4.2 –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–∞–Ω–æ–Ω–∏–º–Ω—ã–µ)
```typescript
// GET /api/v1/users/me
interface UserProfile {
  id: string;
  citizenshipCode: string;    // UZB, TJK, KGZ
  regionCode?: string;        // 77 (–ú–æ—Å–∫–≤–∞)
  entryDate?: string;         // ISO date
  subscriptionType: 'free' | 'plus' | 'pro';
  subscriptionExpiry?: string;
  settings: UserSettings;
  createdAt: string;
}

// PATCH /api/v1/users/me
interface UpdateUserRequest {
  citizenshipCode?: string;
  regionCode?: string;
  entryDate?: string;
  settings?: Partial<UserSettings>;
}

interface UserSettings {
  locale: string;
  notifications: {
    push: boolean;
    telegram: boolean;
    deadlines: boolean;
    news: boolean;
  };
  timezone: string;
}
```

#### 3.4.3 Cloud Safe (E2E Backup)
```typescript
// POST /api/v1/backup
// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
interface BackupUploadRequest {
  encryptedData: string;    // Base64 AES-256-GCM blob
  iv: string;               // Initialization vector
  checksum: string;         // SHA-256 hash
  version: number;          // Schema version
}

interface BackupUploadResponse {
  backupId: string;
  uploadedAt: string;
  sizeBytes: number;
}

// GET /api/v1/backup/latest
interface BackupDownloadResponse {
  backupId: string;
  encryptedData: string;
  iv: string;
  checksum: string;
  version: number;
  createdAt: string;
}

// GET /api/v1/backup/history
interface BackupHistoryResponse {
  backups: {
    id: string;
    createdAt: string;
    sizeBytes: number;
  }[];
}
```

#### 3.4.4 Billing
```typescript
// GET /api/v1/billing/plans
interface PlansResponse {
  plans: {
    id: string;
    name: 'free' | 'plus' | 'pro';
    price: number;           // –í –∫–æ–ø–µ–π–∫–∞—Ö
    period: 'month' | 'year';
    features: string[];
    discount?: {
      percent: number;
      until: string;
    };
  }[];
}

// POST /api/v1/billing/subscribe
interface SubscribeRequest {
  planId: string;
  paymentMethod: 'sbp' | 'card' | 'yookassa';
  returnUrl: string;
}

interface SubscribeResponse {
  paymentId: string;
  paymentUrl: string;       // Redirect URL
  status: 'pending';
}

// POST /api/v1/billing/webhook
// Webhook –æ—Ç –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)

// GET /api/v1/billing/status
interface BillingStatusResponse {
  subscription: {
    type: string;
    expiresAt: string;
    autoRenew: boolean;
  };
  payments: {
    id: string;
    amount: number;
    status: string;
    createdAt: string;
  }[];
}
```

### 3.5 –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

#### 3.5.1 –°—Ö–µ–º–∞ (PostgreSQL)
```sql
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–±–µ–∑ –ü–î–Ω)
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    device_id VARCHAR(64) UNIQUE NOT NULL,
    citizenship_code VARCHAR(3),
    region_code VARCHAR(10),
    entry_date DATE,
    telegram_id_hash VARCHAR(64),  -- SHA256 —Ö–µ—à
    subscription_type VARCHAR(20) DEFAULT 'free',
    subscription_expires_at TIMESTAMPTZ,
    settings JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_device ON users(device_id);
CREATE INDEX idx_users_subscription ON users(subscription_type, subscription_expires_at);

-- –ë—ç–∫–∞–ø—ã (–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ)
CREATE TABLE backups (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    encrypted_data BYTEA NOT NULL,
    iv VARCHAR(32) NOT NULL,
    checksum VARCHAR(64) NOT NULL,
    schema_version INT NOT NULL,
    size_bytes INT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_backups_user ON backups(user_id, created_at DESC);

-- –ü–ª–∞—Ç–µ–∂–∏
CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    external_id VARCHAR(100) UNIQUE,
    amount INT NOT NULL,              -- –ö–æ–ø–µ–π–∫–∏
    currency VARCHAR(3) DEFAULT 'RUB',
    status VARCHAR(20) NOT NULL,      -- pending, completed, failed, refunded
    payment_method VARCHAR(20),
    plan_id VARCHAR(50),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

CREATE INDEX idx_payments_user ON payments(user_id, created_at DESC);
CREATE INDEX idx_payments_status ON payments(status);

-- –ê—É–¥–∏—Ç –ª–æ–≥
CREATE TABLE audit_log (
    id BIGSERIAL,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    user_id UUID,
    action VARCHAR(50) NOT NULL,
    resource VARCHAR(100),
    ip_address INET,
    user_agent TEXT,
    metadata JSONB DEFAULT '{}',
    PRIMARY KEY (timestamp, id)
) PARTITION BY RANGE (timestamp);

-- –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
CREATE TABLE audit_log_2025_01 PARTITION OF audit_log
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 3.6 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### 3.6.1 Rate Limiting
```typescript
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è throttle
const rateLimits = {
  global: { ttl: 60, limit: 100 },      // 100 req/min
  auth: { ttl: 60, limit: 5 },           // 5 req/min
  backup: { ttl: 3600, limit: 10 },      // 10 req/hour
  payment: { ttl: 60, limit: 3 },        // 3 req/min
};
```

#### 3.6.2 Request Signing
```typescript
// –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
interface SignedRequestHeaders {
  'X-Timestamp': string;      // Unix timestamp
  'X-Nonce': string;          // Unique per request
  'X-Signature': string;      // HMAC-SHA256
}

// –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥–ø–∏—Å–∏
const signature = HMAC_SHA256(
  `${method}|${path}|${timestamp}|${nonce}|${bodyHash}`,
  secretKey
);
```

### 3.7 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π | –ú–µ—Ç—Ä–∏–∫–∞ |
|----|----------|---------|
| AC-1.1 | API –æ—Ç–≤–µ—á–∞–µ—Ç < 200ms (p95) | Latency |
| AC-1.2 | Uptime > 99.5% | Availability |
| AC-1.3 | –í—Å–µ endpoints –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ Swagger | Coverage |
| AC-1.4 | Unit tests > 80% coverage | Test coverage |
| AC-1.5 | E2E tests –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö flows | Test count |
| AC-1.6 | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ | Audit |
| AC-1.7 | Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ | Security |

---

## 4. –ú–æ–¥—É–ª—å 2: Identity Service

### 4.1 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–°–µ—Ä–≤–∏—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω (SMS OTP) –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏.

### 4.2 –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

#### 4.2.1 Phone Auth (SMS OTP)
```typescript
// POST /api/v1/auth/phone/send
interface SendOTPRequest {
  phone: string;            // +79001234567
  deviceId: string;
}

interface SendOTPResponse {
  requestId: string;
  expiresIn: number;        // –°–µ–∫—É–Ω–¥—ã –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
  retryAfter: number;       // –°–µ–∫—É–Ω–¥—ã –¥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
}

// POST /api/v1/auth/phone/verify
interface VerifyOTPRequest {
  requestId: string;
  code: string;             // 6 —Ü–∏—Ñ—Ä
  deviceId: string;
}

interface VerifyOTPResponse {
  accessToken: string;
  refreshToken: string;
  isNewUser: boolean;
}
```

#### 4.2.2 Telegram Auth
```typescript
// POST /api/v1/auth/telegram
interface TelegramAuthRequest {
  initData: string;         // Telegram WebApp initData
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ HMAC-SHA256
const secretKey = HMAC_SHA256(botToken, 'WebAppData');
const checkHash = HMAC_SHA256(dataCheckString, secretKey);
```

#### 4.2.3 VK ID Auth
```typescript
// POST /api/v1/auth/vk
interface VKAuthRequest {
  silentToken: string;
  uuid: string;
}

// Exchange —á–µ—Ä–µ–∑ VK API
// GET https://api.vk.com/method/auth.exchangeSilentAuthToken
```

### 4.3 SMS Gateway Integration

#### 4.3.1 –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
1. **SMS.ru** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π (–¥—ë—à–µ–≤–æ, –†–§)
2. **Twilio** ‚Äî —Ä–µ–∑–µ—Ä–≤–Ω—ã–π (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π)

#### 4.3.2 –†–µ–∞–ª–∏–∑–∞—Ü–∏—è
```typescript
interface SMSProvider {
  send(phone: string, message: string): Promise<SMSResult>;
  checkBalance(): Promise<number>;
  getStatus(messageId: string): Promise<SMSStatus>;
}

class SMSService {
  private providers: SMSProvider[];

  async sendOTP(phone: string): Promise<string> {
    const code = generateSecureCode(6);
    const message = `MigrantHub: –≤–∞—à –∫–æ–¥ ${code}. –ù–µ —Å–æ–æ–±—â–∞–π—Ç–µ –µ–≥–æ –Ω–∏–∫–æ–º—É.`;

    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏
    for (const provider of this.providers) {
      try {
        await provider.send(phone, message);
        await this.cacheOTP(phone, code, TTL_5_MINUTES);
        return requestId;
      } catch (e) {
        continue; // Fallback to next
      }
    }
    throw new ServiceUnavailableException();
  }
}
```

### 4.4 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å OTP

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –î–ª–∏–Ω–∞ –∫–æ–¥–∞ | 6 —Ü–∏—Ñ—Ä |
| TTL | 5 –º–∏–Ω—É—Ç |
| –ü–æ–ø—ã—Ç–æ–∫ –≤–≤–æ–¥–∞ | 3 |
| Cooldown –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ | 60 —Å–µ–∫—É–Ω–¥ |
| –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫ | 15 –º–∏–Ω—É—Ç |
| –õ–∏–º–∏—Ç SMS/–¥–µ–Ω—å –Ω–∞ –Ω–æ–º–µ—Ä | 5 |

### 4.5 JWT Configuration
```typescript
const jwtConfig = {
  accessToken: {
    secret: process.env.JWT_ACCESS_SECRET,
    expiresIn: '24h',
  },
  refreshToken: {
    secret: process.env.JWT_REFRESH_SECRET,
    expiresIn: '30d',
  },
};

interface JWTPayload {
  sub: string;        // User ID
  did: string;        // Device ID
  type: 'access' | 'refresh';
  iat: number;
  exp: number;
}
```

### 4.6 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|----|----------|
| AC-2.1 | SMS –¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è < 10 —Å–µ–∫—É–Ω–¥ |
| AC-2.2 | OTP –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| AC-2.3 | Telegram auth –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω |
| AC-2.4 | VK ID auth –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω |
| AC-2.5 | Rate limiting –Ω–∞ SMS |
| AC-2.6 | Fallback –º–µ–∂–¥—É SMS –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ |

---

## 5. –ú–æ–¥—É–ª—å 3: Document Processing

### 5.1 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: OCR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ.

### 5.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –ö–õ–ò–ï–ù–¢                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ Camera  ‚îÇ -> ‚îÇ  Crop   ‚îÇ -> ‚îÇ Local Storage   ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Capture ‚îÇ    ‚îÇ + Prep  ‚îÇ    ‚îÇ (encrypted)     ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                          ‚îÇ          ‚îÇ
‚îÇ                                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ                                 ‚îÇ   OCR Engine    ‚îÇ ‚îÇ
‚îÇ                                 ‚îÇ (Tesseract.js)  ‚îÇ ‚îÇ
‚îÇ                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                          ‚îÇ          ‚îÇ
‚îÇ                                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ                                 ‚îÇ  Data Extract   ‚îÇ ‚îÇ
‚îÇ                                 ‚îÇ  + Validation   ‚îÇ ‚îÇ
‚îÇ                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ (—Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –°–ï–†–í–ï–†                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ Metadata only: document_type, expires_at,   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ is_valid, reminder_sent                     ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 5.3 OCR Implementation

#### 5.3.1 Client-side (Tesseract.js)
```typescript
// src/features/profile/services/ocr.service.ts

import Tesseract from 'tesseract.js';

interface OCRResult {
  text: string;
  confidence: number;
  fields: ExtractedFields;
}

interface ExtractedFields {
  // –ü–∞—Å–ø–æ—Ä—Ç –†–§
  surname?: string;
  name?: string;
  patronymic?: string;
  birthDate?: string;
  gender?: 'M' | 'F';
  passportNumber?: string;
  issueDate?: string;
  issuedBy?: string;

  // –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞
  entryDate?: string;
  entryPurpose?: string;
  stayUntil?: string;

  // –ü–∞—Ç–µ–Ω—Ç
  patentNumber?: string;
  patentRegion?: string;
  patentValidUntil?: string;
}

class OCRService {
  private worker: Tesseract.Worker;

  async initialize(): Promise<void> {
    this.worker = await Tesseract.createWorker('rus+eng');
  }

  async recognizePassport(imageData: Blob): Promise<OCRResult> {
    // –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const processed = await this.preprocessImage(imageData);

    // OCR
    const { data } = await this.worker.recognize(processed);

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ regex
    const fields = this.extractPassportFields(data.text);

    return {
      text: data.text,
      confidence: data.confidence,
      fields,
    };
  }

  private extractPassportFields(text: string): ExtractedFields {
    const patterns = {
      surname: /–§–∞–º–∏–ª–∏—è[:\s]+([–ê-–Ø–Å]+)/i,
      name: /–ò–º—è[:\s]+([–ê-–Ø–Å]+)/i,
      birthDate: /(\d{2}\.\d{2}\.\d{4})/,
      passportNumber: /(\d{2}\s?\d{2}\s?\d{6})/,
    };

    const fields: ExtractedFields = {};
    for (const [key, pattern] of Object.entries(patterns)) {
      const match = text.match(pattern);
      if (match) fields[key] = match[1];
    }

    return fields;
  }

  private async preprocessImage(blob: Blob): Promise<ImageData> {
    // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ grayscale
    // 2. –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞
    // 3. –ë–∏–Ω–∞—Ä–∏–∑–∞—Ü–∏—è (Otsu's method)
    // 4. –£–¥–∞–ª–µ–Ω–∏–µ —à—É–º–∞
    // 5. Deskew (–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ)
    return processedImageData;
  }
}
```

#### 5.3.2 Server-side OCR (fallback)
–î–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –±–µ–∑ –ü–î–Ω:
```typescript
// POST /api/v1/ocr/process
// –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –æ–±—Ä–µ–∑–∞–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–º, –±–µ–∑ —Ñ–æ—Ç–æ –ª–∏—Ü–∞

interface OCRRequest {
  image: string;           // Base64, —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å
  documentType: 'passport' | 'migration_card' | 'patent';
  expectedFields: string[];
}

interface OCRResponse {
  fields: Record<string, string>;
  confidence: number;
}
```

### 5.4 Document Types

| –¢–∏–ø | –ö–æ–¥ | –ü–æ–ª—è |
|-----|-----|------|
| –ü–∞—Å–ø–æ—Ä—Ç | `passport` | –§–ò–û, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è, –Ω–æ–º–µ—Ä, –¥–∞—Ç–∞ –≤—ã–¥–∞—á–∏ |
| –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ | `migration_card` | –î–∞—Ç–∞ –≤—ä–µ–∑–¥–∞, —Ü–µ–ª—å, —Å—Ä–æ–∫ –ø—Ä–µ–±—ã–≤–∞–Ω–∏—è |
| –ü–∞—Ç–µ–Ω—Ç | `patent` | –ù–æ–º–µ—Ä, —Ä–µ–≥–∏–æ–Ω, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è | `registration` | –ê–¥—Ä–µ—Å, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |
| –ò–ù–ù | `inn` | –ù–æ–º–µ—Ä –ò–ù–ù |
| –°–ù–ò–õ–° | `snils` | –ù–æ–º–µ—Ä –°–ù–ò–õ–° |
| –ú–µ–¥–æ—Å–º–æ—Ç—Ä | `medical` | –î–∞—Ç–∞, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è |
| –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —ç–∫–∑–∞–º–µ–Ω–∞ | `exam_cert` | –ù–æ–º–µ—Ä, –¥–∞—Ç–∞, —Å—Ä–æ–∫ |

### 5.5 Local Storage Schema (Dexie.js)
```typescript
// src/lib/db/schema.ts

interface Document {
  id: string;
  type: DocumentType;
  title: string;
  data: EncryptedData;        // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è
  images: EncryptedBlob[];    // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  extractedFields: Record<string, string>;
  expiresAt?: Date;
  reminderDays: number[];     // [30, 14, 7, 3, 1]
  createdAt: Date;
  updatedAt: Date;
}

// Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
db.documents.hook('creating', async (primKey, obj) => {
  obj.data = await encryptData(obj.data);
  obj.images = await Promise.all(
    obj.images.map(img => encryptBlob(img))
  );
});
```

### 5.6 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|----|----------|
| AC-3.1 | OCR —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –ø–∞—Å–ø–æ—Ä—Ç –†–§ —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é > 90% |
| AC-3.2 | OCR —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç –º–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—É—é –∫–∞—Ä—Ç—É |
| AC-3.3 | OCR —Ä–∞–±–æ—Ç–∞–µ—Ç offline (Tesseract.js) |
| AC-3.4 | –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º |
| AC-3.5 | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å—Ä–æ–∫–∞—Ö —Ä–∞–±–æ—Ç–∞—é—Ç |
| AC-3.6 | –≠–∫—Å–ø–æ—Ä—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ PDF |

---

## 6. –ú–æ–¥—É–ª—å 4: AI Assistant

### 6.1 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –º–∏–≥—Ä–∞–Ω—Ç–æ–≤.

### 6.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         –ö–õ–ò–ï–ù–¢                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ User Input ‚îÇ --> ‚îÇ PII Filter  ‚îÇ --> ‚îÇ API Request   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ            ‚îÇ     ‚îÇ (Level 1)   ‚îÇ     ‚îÇ               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                  ‚îÇ
                                                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      API GATEWAY                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ Rate Limit  ‚îÇ --> ‚îÇ PII Filter  ‚îÇ --> ‚îÇ AI Proxy      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ             ‚îÇ     ‚îÇ (Level 2)   ‚îÇ     ‚îÇ               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       AI PROXY                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ PII Filter  ‚îÇ --> ‚îÇ RAG Context ‚îÇ --> ‚îÇ LLM Request   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ (Level 3)   ‚îÇ     ‚îÇ (pgvector)  ‚îÇ     ‚îÇ               ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                   ‚îÇ          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ                    KILL SWITCH                          ‚îÇ‚îÇ
‚îÇ  ‚îÇ  - Manual trigger                                       ‚îÇ‚îÇ
‚îÇ  ‚îÇ  - Auto trigger on anomaly                              ‚îÇ‚îÇ
‚îÇ  ‚îÇ  - Instant disconnect from LLM                          ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                   ‚îÇ
                                                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    LLM PROVIDER                              ‚îÇ
‚îÇ  Primary:   OpenAI GPT-4 Turbo                              ‚îÇ
‚îÇ  Fallback:  GigaChat / YandexGPT                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6.3 PII Filter Implementation

#### 6.3.1 –£—Ä–æ–≤–µ–Ω—å 1 (–ö–ª–∏–µ–Ω—Ç)
```typescript
// src/lib/ai/pii-filter.ts

const PII_PATTERNS = {
  phone: /(\+7|8)[\s-]?\(?\d{3}\)?[\s-]?\d{3}[\s-]?\d{2}[\s-]?\d{2}/g,
  passport: /\d{2}\s?\d{2}\s?\d{6}/g,
  snils: /\d{3}-\d{3}-\d{3}\s?\d{2}/g,
  inn: /\d{10,12}/g,
  email: /[\w.-]+@[\w.-]+\.\w+/g,
  address: /(?:—É–ª\.|—É–ª–∏—Ü–∞|–ø—Ä\.|–ø—Ä–æ—Å–ø–µ–∫—Ç|–¥\.|–¥–æ–º)\s*[\w\s\d,-]+/gi,
  name: /(?:–º–µ–Ω—è –∑–æ–≤—É—Ç|—è\s+)([–ê-–Ø–Å][–∞-—è—ë]+(?:\s+[–ê-–Ø–Å][–∞-—è—ë]+)*)/gi,
};

function filterPII(text: string): { filtered: string; found: PIIMatch[] } {
  const found: PIIMatch[] = [];
  let filtered = text;

  for (const [type, pattern] of Object.entries(PII_PATTERNS)) {
    const matches = text.matchAll(pattern);
    for (const match of matches) {
      found.push({ type, value: match[0], index: match.index });
      filtered = filtered.replace(match[0], `[${type.toUpperCase()}]`);
    }
  }

  return { filtered, found };
}
```

#### 6.3.2 –£—Ä–æ–≤–µ–Ω—å 2 (API Gateway)
```typescript
// NestJS Interceptor
@Injectable()
class PIIFilterInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler) {
    const request = context.switchToHttp().getRequest();

    if (request.body?.message) {
      const { filtered, found } = this.piiFilter.filter(request.body.message);

      if (found.length > 0) {
        this.logger.warn('PII detected', {
          userId: request.user.id,
          types: found.map(f => f.type),
        });
      }

      request.body.message = filtered;
    }

    return next.handle();
  }
}
```

#### 6.3.3 –£—Ä–æ–≤–µ–Ω—å 3 (AI Proxy)
```typescript
// –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM
class AIProxyService {
  async processRequest(message: string, context: ChatContext) {
    // –¢—Ä–µ—Ç–∏–π —É—Ä–æ–≤–µ–Ω—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    const { filtered, found } = this.deepPIIFilter.analyze(message);

    if (found.length > 0) {
      // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Å–∞–º–∏—Ö –¥–∞–Ω–Ω—ã—Ö
      await this.auditLog.record({
        type: 'pii_blocked',
        count: found.length,
        categories: [...new Set(found.map(f => f.type))],
      });
    }

    // RAG context
    const relevantDocs = await this.vectorSearch(filtered);

    // System prompt
    const systemPrompt = this.buildSystemPrompt(relevantDocs);

    // LLM request
    return this.llm.chat({
      system: systemPrompt,
      messages: context.messages,
    });
  }
}
```

### 6.4 RAG (Retrieval Augmented Generation)

#### 6.4.1 Vector Store (pgvector)
```sql
-- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ
CREATE EXTENSION IF NOT EXISTS vector;

-- –¢–∞–±–ª–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
CREATE TABLE legal_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    source VARCHAR(100),          -- 115-–§–ó, –ö–æ–ê–ü, etc.
    chunk_index INT,
    embedding vector(1536),        -- OpenAI ada-002
    metadata JSONB DEFAULT '{}',
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_legal_docs_embedding
ON legal_documents USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

#### 6.4.2 Embedding Pipeline
```typescript
class EmbeddingService {
  async indexDocument(doc: LegalDocument): Promise<void> {
    // –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ chunks
    const chunks = this.splitIntoChunks(doc.content, 1000, 200);

    for (let i = 0; i < chunks.length; i++) {
      const embedding = await this.openai.embeddings.create({
        model: 'text-embedding-ada-002',
        input: chunks[i],
      });

      await this.db.legalDocuments.insert({
        title: doc.title,
        content: chunks[i],
        source: doc.source,
        chunkIndex: i,
        embedding: embedding.data[0].embedding,
      });
    }
  }

  async search(query: string, limit = 5): Promise<LegalDocument[]> {
    const queryEmbedding = await this.embed(query);

    return this.db.$queryRaw`
      SELECT id, title, content, source,
             1 - (embedding <=> ${queryEmbedding}::vector) as similarity
      FROM legal_documents
      ORDER BY embedding <=> ${queryEmbedding}::vector
      LIMIT ${limit}
    `;
  }
}
```

### 6.5 Kill Switch

```typescript
// apps/api-ai/src/kill-switch.service.ts

interface KillSwitchState {
  active: boolean;
  reason?: string;
  activatedAt?: Date;
  activatedBy?: string;
}

@Injectable()
class KillSwitchService {
  private state: KillSwitchState = { active: false };

  // –†—É—á–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ
  async activate(reason: string, userId: string): Promise<void> {
    this.state = {
      active: true,
      reason,
      activatedAt: new Date(),
      activatedBy: userId,
    };

    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await this.alerting.critical('AI Kill Switch Activated', { reason });

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    await this.auditLog.record({
      action: 'kill_switch_activated',
      reason,
      userId,
    });
  }

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ
  async checkAnomaly(metrics: AIMetrics): Promise<void> {
    const triggers = [
      metrics.piiLeakRate > 0.01,           // >1% PII –≤ –æ—Ç–≤–µ—Ç–∞—Ö
      metrics.errorRate > 0.1,               // >10% –æ—à–∏–±–æ–∫
      metrics.avgLatency > 30000,            // >30s latency
      metrics.costPerHour > 100,             // >$100/—á–∞—Å
    ];

    if (triggers.some(t => t)) {
      await this.activate('Automatic: anomaly detected', 'system');
    }
  }

  isActive(): boolean {
    return this.state.active;
  }
}
```

### 6.6 API Endpoints

```typescript
// POST /api/v1/ai/chat
interface ChatRequest {
  message: string;
  conversationId?: string;
  context?: {
    citizenship?: string;
    region?: string;
    documentTypes?: string[];
  };
}

interface ChatResponse {
  message: string;
  conversationId: string;
  sources?: {
    title: string;
    source: string;
  }[];
  suggestedActions?: {
    type: string;
    label: string;
    action: string;
  }[];
}

// GET /api/v1/ai/suggestions
// –ì–æ—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
interface SuggestionsResponse {
  suggestions: {
    category: string;
    questions: string[];
  }[];
}
```

### 6.7 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|----|----------|
| AC-4.1 | 3-—É—Ä–æ–≤–Ω–µ–≤—ã–π PII —Ñ–∏–ª—å—Ç—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-4.2 | RAG –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã |
| AC-4.3 | Kill Switch —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç < 1 —Å–µ–∫—É–Ω–¥—ã |
| AC-4.4 | –û—Ç–≤–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ |
| AC-4.5 | Fallback –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π LLM —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-4.6 | Rate limiting –Ω–∞ AI –∑–∞–ø—Ä–æ—Å—ã |

---

## 7. –ú–æ–¥—É–ª—å 5: Payments

### 7.1 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ –°–ë–ü –∏ –ÆKassa.

### 7.2 –ü–ª–∞—Ç—ë–∂–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–º–∏—Å—Å–∏—è |
|-----------|------------|----------|
| **–°–ë–ü (–ù–°–ü–ö)** | –û—Å–Ω–æ–≤–Ω–æ–π, –†–§ –±–∞–Ω–∫–∏ | 0.4-0.7% |
| **–ÆKassa** | –ö–∞—Ä—Ç—ã, –∫–æ—à–µ–ª—å–∫–∏ | 2.8-3.5% |

### 7.3 –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

```typescript
const SUBSCRIPTION_PLANS = {
  free: {
    id: 'free',
    name: '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π',
    price: 0,
    features: [
      '–•—Ä–∞–Ω–µ–Ω–∏–µ 3 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤',
      '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ä–æ–∫–æ–≤',
      '–ë–∞–∑–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
    ],
  },
  plus: {
    id: 'plus',
    name: '–ü–ª—é—Å',
    price: 9900,  // 99‚ÇΩ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    period: 'month',
    features: [
      '–ë–µ–∑–ª–∏–º–∏—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤',
      'AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (50 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å)',
      '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
      'Cloud Safe (5 –ì–ë)',
    ],
  },
  pro: {
    id: 'pro',
    name: '–ü—Ä–æ',
    price: 29900,  // 299‚ÇΩ
    period: 'month',
    features: [
      '–í—Å—ë –∏–∑ –ü–ª—é—Å',
      'AI –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤',
      '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞',
      '–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏',
      'Cloud Safe (50 –ì–ë)',
    ],
  },
};
```

### 7.4 –°–ë–ü Integration

```typescript
// apps/api-core/src/modules/billing/sbp.service.ts

interface SBPPaymentRequest {
  amount: number;           // –ö–æ–ø–µ–π–∫–∏
  orderId: string;
  description: string;
  returnUrl: string;
}

interface SBPPaymentResponse {
  paymentId: string;
  qrCode: string;           // Base64 QR image
  qrUrl: string;            // Deeplink
  expiresAt: Date;
}

@Injectable()
class SBPService {
  async createPayment(request: SBPPaymentRequest): Promise<SBPPaymentResponse> {
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ –±–∞–Ω–∫–µ-—ç–∫–≤–∞–π–µ—Ä–µ
    const response = await this.acquirerApi.createOrder({
      merchantId: this.config.merchantId,
      amount: request.amount,
      currency: 'RUB',
      orderId: request.orderId,
      description: request.description,
      sbpDetails: {
        qrType: 'dynamic',
        qrTtl: 900,  // 15 –º–∏–Ω—É—Ç
      },
    });

    return {
      paymentId: response.paymentId,
      qrCode: response.qrCode,
      qrUrl: response.qrUrl,
      expiresAt: new Date(Date.now() + 900000),
    };
  }

  async handleWebhook(payload: SBPWebhookPayload): Promise<void> {
    // –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
    if (!this.verifySignature(payload)) {
      throw new UnauthorizedException('Invalid signature');
    }

    const payment = await this.paymentsRepo.findByExternalId(payload.paymentId);

    if (payload.status === 'COMPLETED') {
      await this.activateSubscription(payment.userId, payment.planId);
      await this.paymentsRepo.updateStatus(payment.id, 'completed');
    }
  }
}
```

### 7.5 –ÆKassa Integration

```typescript
// apps/api-core/src/modules/billing/yookassa.service.ts

import { YooKassa } from '@yookassa/sdk';

@Injectable()
class YooKassaService {
  private yookassa: YooKassa;

  constructor() {
    this.yookassa = new YooKassa({
      shopId: process.env.YOOKASSA_SHOP_ID,
      secretKey: process.env.YOOKASSA_SECRET_KEY,
    });
  }

  async createPayment(request: PaymentRequest): Promise<PaymentResponse> {
    const payment = await this.yookassa.createPayment({
      amount: {
        value: (request.amount / 100).toFixed(2),
        currency: 'RUB',
      },
      confirmation: {
        type: 'redirect',
        return_url: request.returnUrl,
      },
      capture: true,
      description: request.description,
      metadata: {
        orderId: request.orderId,
        userId: request.userId,
        planId: request.planId,
      },
    });

    return {
      paymentId: payment.id,
      paymentUrl: payment.confirmation.confirmation_url,
      status: 'pending',
    };
  }
}
```

### 7.6 Webhook Security

```typescript
// –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è webhook –æ—Ç –ÆKassa
function verifyYooKassaWebhook(body: string, signature: string): boolean {
  const expectedSignature = crypto
    .createHmac('sha256', process.env.YOOKASSA_WEBHOOK_SECRET)
    .update(body)
    .digest('hex');

  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature)
  );
}
```

### 7.7 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|----|----------|
| AC-5.1 | –°–ë–ü –æ–ø–ª–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (QR + deeplink) |
| AC-5.2 | –ÆKassa –æ–ø–ª–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-5.3 | Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ |
| AC-5.4 | –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã |
| AC-5.5 | –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-5.6 | –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –≤–æ–∑–º–æ–∂–µ–Ω |

---

## 8. –ú–æ–¥—É–ª—å 6: Notifications

### 8.1 –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
–ú–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: Push, Telegram, Email.

### 8.2 –ö–∞–Ω–∞–ª—ã

| –ö–∞–Ω–∞–ª | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | Use Case |
|-------|-----------|----------|
| **Push (FCM/APNs)** | –í—ã—Å–æ–∫–∏–π | –°—Ä–æ—á–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è |
| **Telegram Bot** | –°—Ä–µ–¥–Ω–∏–π | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –Ω–æ–≤–æ—Å—Ç–∏ |
| **Email** | –ù–∏–∑–∫–∏–π | –û—Ç—á—ë—Ç—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã |

### 8.3 Notification Types

```typescript
enum NotificationType {
  // –î–æ–∫—É–º–µ–Ω—Ç—ã
  DOCUMENT_EXPIRING = 'document_expiring',
  DOCUMENT_EXPIRED = 'document_expired',

  // –ü–∞—Ç–µ–Ω—Ç
  PATENT_PAYMENT_DUE = 'patent_payment_due',
  PATENT_PAYMENT_OVERDUE = 'patent_payment_overdue',

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  REGISTRATION_EXPIRING = 'registration_expiring',
  REGISTRATION_EXPIRED = 'registration_expired',

  // –ú–∏–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —É—á—ë—Ç
  STAY_LIMIT_WARNING = 'stay_limit_warning',
  STAY_LIMIT_CRITICAL = 'stay_limit_critical',

  // –ó–∞–∫–æ–Ω—ã
  LAW_UPDATE = 'law_update',

  // –°–∏—Å—Ç–µ–º–∞
  BACKUP_REMINDER = 'backup_reminder',
  SUBSCRIPTION_EXPIRING = 'subscription_expiring',
}
```

### 8.4 Smart Timing

```typescript
// –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
interface NotificationScheduler {
  // –£—á—ë—Ç —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  getOptimalTime(userId: string, type: NotificationType): Date;

  // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ—á—å—é (22:00 - 08:00 –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏)
  isQuietHours(userId: string): boolean;

  // Escalation –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö
  getEscalationSchedule(type: NotificationType): EscalationStep[];
}

const ESCALATION_SCHEDULES = {
  [NotificationType.PATENT_PAYMENT_DUE]: [
    { daysBefore: 30, channel: 'push', priority: 'normal' },
    { daysBefore: 14, channel: 'push', priority: 'normal' },
    { daysBefore: 7, channel: 'push', priority: 'high' },
    { daysBefore: 3, channel: 'push', priority: 'high', repeat: true },
    { daysBefore: 1, channel: 'push', priority: 'critical', repeat: true },
  ],
};
```

### 8.5 FCM Integration

```typescript
// apps/api-core/src/modules/notifications/fcm.service.ts

import * as admin from 'firebase-admin';

@Injectable()
class FCMService {
  async send(notification: PushNotification): Promise<void> {
    const message: admin.messaging.Message = {
      token: notification.fcmToken,
      notification: {
        title: notification.title,
        body: notification.body,
      },
      data: notification.data,
      android: {
        priority: notification.priority === 'critical' ? 'high' : 'normal',
        notification: {
          channelId: this.getChannelId(notification.type),
          sound: notification.priority === 'critical' ? 'alarm' : 'default',
        },
      },
      apns: {
        payload: {
          aps: {
            sound: notification.priority === 'critical' ? 'alarm.caf' : 'default',
            badge: notification.badge,
          },
        },
      },
    };

    await admin.messaging().send(message);
  }
}
```

### 8.6 Telegram Bot

```typescript
// apps/api-notify/src/telegram-bot.service.ts

import { Telegraf } from 'telegraf';

@Injectable()
class TelegramBotService {
  private bot: Telegraf;

  async sendNotification(chatId: string, notification: TelegramNotification) {
    const message = this.formatMessage(notification);

    await this.bot.telegram.sendMessage(chatId, message, {
      parse_mode: 'HTML',
      reply_markup: notification.buttons ? {
        inline_keyboard: notification.buttons.map(btn => [{
          text: btn.text,
          url: btn.url,
        }]),
      } : undefined,
    });
  }

  private formatMessage(n: TelegramNotification): string {
    const icons = {
      warning: '‚ö†Ô∏è',
      critical: 'üö®',
      info: '‚ÑπÔ∏è',
      success: '‚úÖ',
    };

    return `${icons[n.severity]} <b>${n.title}</b>\n\n${n.body}`;
  }
}
```

### 8.7 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|----|----------|
| AC-6.1 | Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è (FCM) |
| AC-6.2 | Telegram –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-6.3 | Smart timing —É—á–∏—Ç—ã–≤–∞–µ—Ç —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å |
| AC-6.4 | Escalation –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-6.5 | Snooze —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-6.6 | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è |

---

## 9. Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### 9.1 API Client

```typescript
// src/lib/api/client.ts

import { createRequestSigner } from './signing';

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL;

class APIClient {
  private accessToken: string | null = null;
  private signer = createRequestSigner();

  async request<T>(
    method: string,
    path: string,
    data?: unknown
  ): Promise<T> {
    const timestamp = Date.now().toString();
    const nonce = crypto.randomUUID();
    const body = data ? JSON.stringify(data) : '';

    const signature = await this.signer.sign({
      method,
      path,
      timestamp,
      nonce,
      body,
    });

    const response = await fetch(`${API_BASE_URL}${path}`, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': this.accessToken ? `Bearer ${this.accessToken}` : '',
        'X-Timestamp': timestamp,
        'X-Nonce': nonce,
        'X-Signature': signature,
      },
      body: body || undefined,
    });

    if (!response.ok) {
      throw new APIError(response.status, await response.json());
    }

    return response.json();
  }

  // Typed methods
  auth = {
    device: (data: DeviceAuthRequest) =>
      this.request<DeviceAuthResponse>('POST', '/api/v1/auth/device', data),
    refresh: (data: RefreshRequest) =>
      this.request<RefreshResponse>('POST', '/api/v1/auth/refresh', data),
  };

  users = {
    me: () => this.request<UserProfile>('GET', '/api/v1/users/me'),
    update: (data: UpdateUserRequest) =>
      this.request<UserProfile>('PATCH', '/api/v1/users/me', data),
  };

  ai = {
    chat: (data: ChatRequest) =>
      this.request<ChatResponse>('POST', '/api/v1/ai/chat', data),
  };

  backup = {
    upload: (data: BackupUploadRequest) =>
      this.request<BackupUploadResponse>('POST', '/api/v1/backup', data),
    download: () =>
      this.request<BackupDownloadResponse>('GET', '/api/v1/backup/latest'),
  };
}

export const api = new APIClient();
```

### 9.2 React Query Hooks

```typescript
// src/lib/hooks/useUser.ts

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { api } from '../api/client';

export function useUser() {
  return useQuery({
    queryKey: ['user', 'me'],
    queryFn: () => api.users.me(),
    staleTime: 5 * 60 * 1000, // 5 min
  });
}

export function useUpdateUser() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: api.users.update,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['user'] });
    },
  });
}

// src/lib/hooks/useAI.ts

export function useAIChat() {
  return useMutation({
    mutationFn: api.ai.chat,
  });
}
```

### 9.3 Offline Sync

```typescript
// src/lib/sync/sync-manager.ts

class SyncManager {
  private db: Dexie;
  private api: APIClient;

  async sync(): Promise<SyncResult> {
    if (!navigator.onLine) {
      return { status: 'offline' };
    }

    const pendingActions = await this.db.syncQueue.toArray();
    const results: SyncItemResult[] = [];

    for (const action of pendingActions) {
      try {
        await this.executeAction(action);
        await this.db.syncQueue.delete(action.id);
        results.push({ id: action.id, status: 'success' });
      } catch (error) {
        results.push({ id: action.id, status: 'failed', error });
      }
    }

    return { status: 'complete', results };
  }

  async queueAction(action: SyncAction): Promise<void> {
    await this.db.syncQueue.add({
      ...action,
      createdAt: new Date(),
      retries: 0,
    });

    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å—Ä–∞–∑—É –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω
    if (navigator.onLine) {
      this.sync();
    }
  }
}
```

### 9.4 –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

| ID | –ö—Ä–∏—Ç–µ—Ä–∏–π |
|----|----------|
| AC-7.1 | API client —Å –ø–æ–¥–ø–∏—Å—å—é –∑–∞–ø—Ä–æ—Å–æ–≤ |
| AC-7.2 | React Query hooks –¥–ª—è –≤—Å–µ—Ö endpoints |
| AC-7.3 | Offline queue —Ä–∞–±–æ—Ç–∞–µ—Ç |
| AC-7.4 | Auto-sync –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏ |
| AC-7.5 | Error handling —Å retry |
| AC-7.6 | Loading states –≤–æ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö |

---

## 10. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 10.1 –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

| –£—Ä–æ–≤–µ–Ω—å | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç | Coverage Target |
|---------|------------|-----------------|
| Unit | Vitest | > 80% |
| Integration | Vitest + Supertest | > 70% |
| E2E | Playwright | Critical paths |
| Load | k6 | 1000 RPS |

### 10.2 Unit Tests

```typescript
// Example: PII Filter test
describe('PIIFilter', () => {
  it('should mask phone numbers', () => {
    const input = '–ú–æ–π –Ω–æ–º–µ—Ä +79001234567';
    const { filtered } = filterPII(input);
    expect(filtered).toBe('–ú–æ–π –Ω–æ–º–µ—Ä [PHONE]');
  });

  it('should mask passport numbers', () => {
    const input = '–ü–∞—Å–ø–æ—Ä—Ç 45 06 123456';
    const { filtered } = filterPII(input);
    expect(filtered).toBe('–ü–∞—Å–ø–æ—Ä—Ç [PASSPORT]');
  });

  it('should mask multiple PII types', () => {
    const input = '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω, +79001234567, –ø–∞—Å–ø–æ—Ä—Ç 4506 123456';
    const { filtered, found } = filterPII(input);
    expect(found).toHaveLength(3);
  });
});
```

### 10.3 E2E Tests

```typescript
// tests/e2e/auth.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Authentication', () => {
  test('should complete phone auth flow', async ({ page }) => {
    await page.goto('/auth/phone');

    await page.fill('[data-testid="phone-input"]', '+79001234567');
    await page.click('[data-testid="send-otp-button"]');

    await expect(page).toHaveURL('/auth/otp');

    // –í —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ OTP = 123456
    await page.fill('[data-testid="otp-input"]', '123456');
    await page.click('[data-testid="verify-button"]');

    await expect(page).toHaveURL('/dashboard');
  });
});
```

### 10.4 Load Tests

```javascript
// tests/load/api.js (k6)

import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 100 },
    { duration: '3m', target: 500 },
    { duration: '1m', target: 1000 },
    { duration: '5m', target: 1000 },
    { duration: '1m', target: 0 },
  ],
  thresholds: {
    http_req_duration: ['p(95)<200'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('http://api.migranthub.local/api/v1/health');
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200,
  });
  sleep(1);
}
```

---

## 11. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 11.1 –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     CLOUDFLARE                              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ   WAF   ‚îÇ  ‚îÇ   CDN   ‚îÇ  ‚îÇ       DDoS Protection       ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ            ‚îÇ                    ‚îÇ
        ‚ñº            ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     SELECTEL VPC                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ                   LOAD BALANCER                         ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ                           ‚îÇ                                 ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ    ‚îÇ                      ‚îÇ                      ‚îÇ         ‚îÇ
‚îÇ    ‚ñº                      ‚ñº                      ‚ñº         ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ ‚îÇ API  ‚îÇ              ‚îÇ API  ‚îÇ              ‚îÇ API  ‚îÇ       ‚îÇ
‚îÇ ‚îÇ Core ‚îÇ              ‚îÇ  AI  ‚îÇ              ‚îÇNotify‚îÇ       ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ    ‚îÇ                     ‚îÇ                     ‚îÇ           ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
‚îÇ                          ‚îÇ                                  ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ    ‚îÇ                     ‚îÇ                     ‚îÇ           ‚îÇ
‚îÇ    ‚ñº                     ‚ñº                     ‚ñº           ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ ‚îÇPostgr‚îÇ              ‚îÇRedis ‚îÇ              ‚îÇRabbit‚îÇ       ‚îÇ
‚îÇ ‚îÇ SQL  ‚îÇ              ‚îÇ      ‚îÇ              ‚îÇ  MQ  ‚îÇ       ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 11.2 Docker Compose

```yaml
# docker-compose.yml

version: '3.8'

services:
  api-core:
    build: ./apps/api-core
    environment:
      - DATABASE_URL=postgres://user:pass@postgres:5432/migranthub
      - REDIS_URL=redis://redis:6379
      - RABBITMQ_URL=amqp://rabbitmq:5672
    depends_on:
      - postgres
      - redis
      - rabbitmq
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '1'
          memory: 1G
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3

  api-ai:
    build: ./apps/api-ai
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=postgres://user:pass@postgres:5432/migranthub
    depends_on:
      - postgres
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  api-notify:
    build: ./apps/api-notify
    environment:
      - FCM_CREDENTIALS=${FCM_CREDENTIALS}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - RABBITMQ_URL=amqp://rabbitmq:5672
    depends_on:
      - rabbitmq
    deploy:
      replicas: 1

  legal-core:
    build: ./apps/legal-core
    environment:
      - DATABASE_URL=postgres://user:pass@postgres:5432/migranthub
      - RABBITMQ_URL=amqp://rabbitmq:5672
    depends_on:
      - postgres
      - rabbitmq

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=migranthub
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  redis:
    image: redis:7-alpine
    volumes:
      - redis_data:/data

  rabbitmq:
    image: rabbitmq:3-management-alpine
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
```

### 11.3 CI/CD Pipeline

```yaml
# .github/workflows/deploy.yml

name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test
      - run: npm run lint

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker images
        run: |
          docker build -t migranthub/api-core ./apps/api-core
          docker build -t migranthub/api-ai ./apps/api-ai
          docker build -t migranthub/api-notify ./apps/api-notify
      - name: Push to registry
        run: |
          echo ${{ secrets.REGISTRY_PASSWORD }} | docker login -u ${{ secrets.REGISTRY_USER }} --password-stdin
          docker push migranthub/api-core
          docker push migranthub/api-ai
          docker push migranthub/api-notify

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Selectel
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/migranthub
            docker compose pull
            docker compose up -d --remove-orphans
```

---

## 12. Roadmap

### Phase 1: MVP (4 –Ω–µ–¥–µ–ª–∏)

| –ù–µ–¥–µ–ª—è | –ó–∞–¥–∞—á–∏ |
|--------|--------|
| 1 | Backend Core API + Identity Service |
| 2 | Document Processing (OCR) + Cloud Safe |
| 3 | Payments (–°–ë–ü + –ÆKassa) |
| 4 | Notifications + Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è |

### Phase 2: AI + Polish (2 –Ω–µ–¥–µ–ª–∏)

| –ù–µ–¥–µ–ª—è | –ó–∞–¥–∞—á–∏ |
|--------|--------|
| 5 | AI Assistant + RAG |
| 6 | Testing + Bug fixes + Launch prep |

### Phase 3: Expansion (ongoing)

- B2B –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- –ü–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞

---

## 13. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### A. –ì–ª–æ—Å—Å–∞—Ä–∏–π

| –¢–µ—Ä–º–∏–Ω | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |
|--------|-------------|
| –ü–î–Ω | –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| 152-–§–ó | –§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω –æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö |
| –°–ë–ü | –°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π |
| E2E | End-to-end (—Å–∫–≤–æ–∑–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ) |
| RAG | Retrieval Augmented Generation |
| PII | Personally Identifiable Information |

### B. –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](./architecture/00-ARCHITECTURE-OVERVIEW.md)
- [–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞](./architecture/01-INFRASTRUCTURE.md)
- [–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö](./architecture/02-DATABASE.md)
- [API](./architecture/03-API.md)
- [Frontend](./architecture/04-FRONTEND.md)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](./architecture/05-SECURITY.md)
- [–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞](./architecture/06-BUSINESS-LOGIC.md)

### C. –ö–æ–Ω—Ç–∞–∫—Ç—ã

| –†–æ–ª—å | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å |
|------|-----------------|
| Product Owner | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è |
| Tech Lead | –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –∫–æ–¥-—Ä–µ–≤—å—é |
| Backend Dev | API, –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö |
| Frontend Dev | UI, –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ |
| DevOps | –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞, CI/CD |

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-25
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2025-01-25
