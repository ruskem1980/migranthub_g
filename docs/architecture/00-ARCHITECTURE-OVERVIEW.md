# MigrantHub — Полная Архитектурная Документация

> Версия: 1.0.0
> Дата: Январь 2025
> Статус: Утверждено

---

## Содержание

1. [Обзор продукта](#1-обзор-продукта)
2. [Архитектурные принципы](#2-архитектурные-принципы)
3. [Системная архитектура](#3-системная-архитектура)
4. [Compliance 152-ФЗ](#4-compliance-152-фз)
5. [Технологический стек](#5-технологический-стек)
6. [Структура документации](#6-структура-документации)

---

## 1. Обзор продукта

### 1.1 Миссия

**MigrantHub** — цифровая экосистема для трудовых мигрантов в России, помогающая соблюдать законодательство и избегать депортации.

### 1.2 Целевая аудитория

| Сегмент | Размер | Приоритет |
|---------|--------|-----------|
| Трудовые мигранты из Узбекистана | 2.5M | P0 |
| Трудовые мигранты из Таджикистана | 1.2M | P0 |
| Трудовые мигранты из Кыргызстана | 0.8M | P0 |
| Граждане ЕАЭС (KZ, AM, BY) | 0.5M | P1 |
| Работодатели мигрантов | 100K компаний | P1 (B2B) |

### 1.3 Ключевые функции

```
┌─────────────────────────────────────────────────────────────┐
│                    CORE FEATURES                             │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  📄 ДОКУМЕНТЫ                                                │
│  ├── Хранение сканов и данных документов                    │
│  ├── Отслеживание сроков действия                           │
│  └── Автоматические напоминания                             │
│                                                              │
│  ⏰ ДЕДЛАЙНЫ                                                 │
│  ├── Калькулятор 90/180 дней                                │
│  ├── Сроки регистрации                                      │
│  ├── Оплата патента                                         │
│  └── Персональный чеклист                                   │
│                                                              │
│  🤖 AI-ПОМОЩНИК                                              │
│  ├── Ответы на вопросы о законодательстве                   │
│  ├── RAG по базе знаний                                     │
│  └── Многоязычная поддержка (5 языков)                      │
│                                                              │
│  📚 СПРАВОЧНИК                                               │
│  ├── Актуальные законы                                      │
│  ├── Образцы документов                                     │
│  ├── Калькуляторы (патент, штрафы)                          │
│  └── Полезные контакты                                      │
│                                                              │
│  🔔 УВЕДОМЛЕНИЯ                                              │
│  ├── Push-уведомления                                       │
│  ├── Telegram бот                                           │
│  ├── VK Макс интеграция                                     │
│  └── Умные напоминания                                      │
│                                                              │
│  ☁️ CLOUD SAFE (платная опция)                               │
│  ├── E2E зашифрованный бэкап                                │
│  ├── Синхронизация между устройствами                       │
│  └── История версий                                         │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 Платформы

- **iOS** — App Store (iPhone 12+, iOS 15+)
- **Android** — Google Play + RuStore (Android 8+)
- **PWA** — Веб-версия для любых устройств

---

## 2. Архитектурные принципы

### 2.1 Local-First Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   LOCAL-FIRST PRINCIPLE                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  УСТРОЙСТВО ПОЛЬЗОВАТЕЛЯ                 СЕРВЕР             │
│  ┌─────────────────────┐                ┌──────────────────┐│
│  │                     │                │                  ││
│  │  ✅ Паспортные данные│                │  ❌ PII          ││
│  │  ✅ Сканы документов │                │  ✅ citizenship   ││
│  │  ✅ ФИО              │   ───────────► │  ✅ region_code  ││
│  │  ✅ Адрес            │   Анонимные    │  ✅ entry_date   ││
│  │  ✅ Телефон          │   метаданные   │  ✅ tg_id_hash   ││
│  │                     │                │                  ││
│  │  🔐 AES-256-GCM     │                │  📊 Analytics    ││
│  │  🔑 Ключ в Keychain │                │                  ││
│  │                     │                │                  ││
│  └─────────────────────┘                └──────────────────┘│
│                                                              │
│  РЕЗУЛЬТАТ: Мы НЕ оператор персональных данных по 152-ФЗ    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 Offline-First

Приложение полностью функционально без интернета:

- Все данные хранятся локально в IndexedDB
- Справочник законов кэшируется
- AI работает только онлайн (с graceful degradation)
- Изменения синхронизируются при появлении сети

### 2.3 Privacy by Design

| Принцип | Реализация |
|---------|------------|
| Data minimization | Собираем только необходимые данные |
| Purpose limitation | Данные используются только для заявленных целей |
| Storage limitation | Автоматическое удаление неактивных данных |
| Encryption | AES-256-GCM для всех PII |
| Access control | Биометрия для доступа к данным |

### 2.4 Fault Isolation

```
┌─────────────────────────────────────────────────────────────┐
│                   MICROSERVICES ISOLATION                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  api-core   │  │   api-ai    │  │ api-notify  │          │
│  │             │  │             │  │             │          │
│  │ Auth/Users  │  │ PII Filter  │  │  Telegram   │          │
│  │ Billing     │  │ OpenAI      │  │  VK/Push    │          │
│  │ Backup      │  │ RAG         │  │             │          │
│  │             │  │             │  │             │          │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘          │
│         │                │                │                  │
│         └────────────────┼────────────────┘                  │
│                          │                                   │
│                   ┌──────┴──────┐                            │
│                   │ Circuit     │                            │
│                   │ Breaker     │                            │
│                   └─────────────┘                            │
│                                                              │
│  Падение api-ai НЕ влияет на api-core и api-notify          │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Системная архитектура

### 3.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            MIGRANTHUB ARCHITECTURE                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  CLIENTS                                                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐       │
│  │   iOS    │  │ Android  │  │   PWA    │  │ Telegram │  │ VK Макс  │       │
│  │ Capacitor│  │ Capacitor│  │  Next.js │  │   Bot    │  │ Mini App │       │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘       │
│       │             │             │             │             │              │
│       └─────────────┴──────┬──────┴─────────────┴─────────────┘              │
│                            │                                                 │
│                            ▼                                                 │
│  CDN / EDGE        ┌──────────────┐                                         │
│                    │  Cloudflare  │                                         │
│                    │  - WAF       │                                         │
│                    │  - DDoS      │                                         │
│                    │  - Cache     │                                         │
│                    └──────┬───────┘                                         │
│                           │                                                  │
│                           ▼                                                  │
│  LOAD BALANCER    ┌──────────────┐                                         │
│                   │    Nginx     │                                         │
│                   │  - SSL Term  │                                         │
│                   │  - Routing   │                                         │
│                   └──────┬───────┘                                         │
│                          │                                                  │
│         ┌────────────────┼────────────────┬────────────────┐                │
│         ▼                ▼                ▼                ▼                │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │  api-core  │  │   api-ai   │  │ api-notify │  │ legal-core │            │
│  │            │  │            │  │            │  │            │            │
│  │ - Auth     │  │ - PII Filt │  │ - Telegram │  │ - Laws     │            │
│  │ - Users    │  │ - OpenAI   │  │ - VK       │  │ - Monitor  │            │
│  │ - Billing  │  │ - RAG      │  │ - Push     │  │ - Forms    │            │
│  │ - Backup   │  │            │  │            │  │            │            │
│  │            │  │            │  │            │  │            │            │
│  │  1GB RAM   │  │  1GB RAM   │  │  512MB RAM │  │  512MB RAM │            │
│  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘            │
│        │               │               │               │                    │
│        └───────────────┴───────┬───────┴───────────────┘                    │
│                                │                                            │
│                                ▼                                            │
│  MESSAGE QUEUE        ┌──────────────┐                                     │
│                       │  RabbitMQ    │                                     │
│                       │  - Events    │                                     │
│                       │  - Jobs      │                                     │
│                       └──────┬───────┘                                     │
│                              │                                              │
│         ┌────────────────────┼────────────────────┐                        │
│         ▼                    ▼                    ▼                        │
│  ┌────────────┐      ┌────────────┐      ┌────────────┐                   │
│  │ PostgreSQL │      │   Redis    │      │ S3/MinIO   │                   │
│  │            │      │            │      │            │                   │
│  │ - Users    │      │ - Cache    │      │ - Backups  │                   │
│  │ - Payments │      │ - Sessions │      │ - Files    │                   │
│  │ - Audit    │      │ - Queues   │      │ - Exports  │                   │
│  │ - Laws     │      │ - Rate Lim │      │            │                   │
│  │ - pgvector │      │            │      │            │                   │
│  └────────────┘      └────────────┘      └────────────┘                   │
│                                                                            │
│  EXTERNAL SERVICES                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    │
│  │  OpenAI  │  │ Telegram │  │    VK    │  │  ЮKassa  │  │   СБП    │    │
│  │   API    │  │   API    │  │   API    │  │   API    │  │   API    │    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘    │
│                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Data Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. ДОБАВЛЕНИЕ ДОКУМЕНТА                                                     │
│                                                                              │
│  User fills form ──► Local encryption ──► Save to IndexedDB                  │
│                             │                                                │
│                             ▼                                                │
│                      Send anonymous metadata ──► Server DB                   │
│                      (type, expires_at, no PII)                              │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  2. AI ЗАПРОС                                                                │
│                                                                              │
│  User question ──► Client PII Filter ──► API Gateway Filter ──►              │
│                           │                      │                           │
│                           ▼                      ▼                           │
│                    Block if PII found     AI Proxy Filter ──► OpenAI         │
│                                                  │                           │
│                                                  ▼                           │
│                                           Log (anonymized) ──► Audit DB      │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  3. BACKUP (Cloud Safe)                                                      │
│                                                                              │
│  Local data ──► Encrypt with user key ──► Get presigned URL ──►              │
│                        │                         │                           │
│                        ▼                         ▼                           │
│                 AES-256-GCM              Upload to S3 (encrypted blob)       │
│                                                                              │
│  Server CANNOT decrypt backup (no access to user key)                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Compliance 152-ФЗ

### 4.1 Почему мы НЕ оператор персональных данных

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      152-ФЗ COMPLIANCE STRATEGY                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ОПРЕДЕЛЕНИЕ ОПЕРАТОРА ПД (ст. 3 152-ФЗ):                                   │
│  "Лицо, осуществляющее обработку персональных данных"                       │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  НАШ ПОДХОД:                                                                 │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      МЫ НЕ ХРАНИМ PII НА СЕРВЕРЕ                    │    │
│  │                                                                      │    │
│  │  ❌ Не храним: ФИО, паспортные данные, адрес, телефон, email        │    │
│  │  ❌ Не храним: сканы документов, фото                               │    │
│  │  ❌ Не храним: точные даты рождения                                 │    │
│  │                                                                      │    │
│  │  ✅ Храним только:                                                   │    │
│  │     - citizenship_code: "UZ" (код страны, не гражданство лица)      │    │
│  │     - region_code: "77" (код региона, не адрес)                     │    │
│  │     - entry_date: дата въезда (не связана с личностью без PII)      │    │
│  │     - telegram_id_hash: SHA256 хеш (необратимо)                     │    │
│  │     - device_id: технический идентификатор устройства               │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ДОПОЛНИТЕЛЬНЫЕ МЕРЫ:                                                        │
│                                                                              │
│  1. AI запросы                                                               │
│     - 3-уровневый PII фильтр                                                │
│     - Kill Switch при обнаружении утечки                                    │
│     - Логи без персональных данных                                          │
│                                                                              │
│  2. Backups                                                                  │
│     - E2E шифрование (ключ только у пользователя)                           │
│     - Мы не можем расшифровать бэкапы                                       │
│     - = Не обрабатываем PII                                                 │
│                                                                              │
│  3. Аналитика                                                                │
│     - Только агрегированные данные                                          │
│     - Нет связи с конкретными пользователями                                │
│                                                                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                              │
│  ВЫВОД: Мы не осуществляем обработку персональных данных                    │
│         = Не являемся оператором ПД по 152-ФЗ                               │
│         = Не требуется регистрация в реестре РКН                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Incident Response для 152-ФЗ

Несмотря на то, что мы не операторы ПД, мы готовы к инцидентам:

| Severity | Response Time | Actions |
|----------|---------------|---------|
| P1 (Critical) | 15 мин | Kill Switch, уведомление команды, forensics |
| P2 (High) | 1 час | Блокировка устройства, расследование |
| P3 (Medium) | 4 часа | Логирование, патч |
| P4 (Low) | 24 часа | Тикет, планирование фикса |

---

## 5. Технологический стек

### 5.1 Frontend / Mobile

| Компонент | Технология | Версия |
|-----------|------------|--------|
| Framework | Next.js | 14.x |
| Language | TypeScript | 5.x |
| Mobile | Capacitor | 5.x |
| State | Zustand + React Query | 4.x / 5.x |
| Storage | Dexie.js (IndexedDB) | 4.x |
| UI | Tailwind + Radix | 3.x |
| Forms | React Hook Form + Zod | 7.x |
| Crypto | Web Crypto API | native |

### 5.2 Backend

| Компонент | Технология | Версия |
|-----------|------------|--------|
| Framework | NestJS | 10.x |
| Language | TypeScript | 5.x |
| ORM | Prisma | 5.x |
| Database | PostgreSQL + pgvector | 16.x |
| Cache | Redis | 7.x |
| Queue | RabbitMQ | 3.x |
| Storage | S3 (MinIO) | latest |

### 5.3 Infrastructure

| Компонент | Технология |
|-----------|------------|
| Hosting | Selectel Cloud |
| CDN/WAF | Cloudflare |
| Containers | Docker + Docker Compose |
| CI/CD | GitHub Actions |
| Monitoring | Sentry + Grafana |
| Logs | Loki |

### 5.4 External Services

| Сервис | Назначение |
|--------|------------|
| OpenAI GPT-4 | AI-помощник |
| Telegram API | Бот + уведомления |
| VK API | Макс Mini App + уведомления |
| ЮKassa | Платежи картой |
| СБП | Быстрые платежи |
| Firebase/RuStore | Push-уведомления |

---

## 6. Структура документации

### 6.1 Документы архитектуры

```
docs/architecture/
├── 00-ARCHITECTURE-OVERVIEW.md      # Этот документ
├── 01-INFRASTRUCTURE.md             # Инфраструктура и DevOps
├── 02-DATABASE.md                   # Схема БД и миграции
├── 03-API.md                        # API спецификация
├── 04-FRONTEND.md                   # Фронтенд и мобильное приложение
├── 05-SECURITY.md                   # Безопасность и compliance
├── 06-BUSINESS-LOGIC.md             # Бизнес-логика и монетизация
└── 07-DEPLOYMENT.md                 # Деплой и операции
```

### 6.2 Связанные документы

- `README.md` — Общее описание проекта
- `CONTRIBUTING.md` — Гайд для контрибьюторов
- `CHANGELOG.md` — История изменений
- `docs/api/openapi.yaml` — OpenAPI спецификация
- `docs/runbooks/` — Операционные процедуры

---

## Changelog

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0.0 | 2025-01 | Team | Первоначальная версия |

---

*Документ сгенерирован на основе архитектурного опросника (50 вопросов)*
